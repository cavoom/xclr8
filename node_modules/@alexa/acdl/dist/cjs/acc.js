#!/usr/bin/env node
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.runCommand = void 0;
require("source-map-support/register");
const client_cloudformation_1 = require("@aws-sdk/client-cloudformation");
const client_secrets_manager_1 = require("@aws-sdk/client-secrets-manager");
const credential_provider_node_1 = require("@aws-sdk/credential-provider-node");
const path_1 = __importDefault(require("path"));
const yargs_1 = __importDefault(require("yargs"));
const util_1 = require("./util");
const ProfileNameGetter_1 = require("./acc/ProfileNameGetter");
const Decompile_1 = require("./acc/Decompile");
const CompileZipAndDeploy_1 = require("./acc/CompileZipAndDeploy");
const NPMPackageVersionCheck_1 = require("./acc/NPMPackageVersionCheck");
const ask_cli_config_1 = require("./ask-cli-config");
const metric_client_1 = require("./metrics/metric-client");
const error_1 = require("./error");
/**
 * Processes and defines the command line arguments
 * @param localNpmVersion current npm package version
 * @returns the arguments processed by yargs
 */
function getArguments(localNpmVersion) {
    const { argv } = (0, yargs_1.default)(process.argv.slice(2))
        .scriptName("acc")
        .version(localNpmVersion)
        .usage("Usage: $0")
        .alias("h", "help")
        .help("help")
        .showHelpOnFail(true)
        // .command(["$0", "build"], "compile a single ACDL file to ASKIR", () => {})
        .command("compile", "compile ASKIR modules and, for ski", (yargs) => yargs
        .option("skip-validation", {
        type: "boolean",
        demandOption: false,
        default: false,
        description: "Force the CLI to generate ASKIR without validation.",
    })
        .option("profile", {
        type: "string",
        requiresArg: false,
        description: "ASK CLI profile to use for the Skill.",
    }))
        .command("package", "create a skill-package", (yargs) => yargs
        .option("skip-validation", {
        type: "boolean",
        demandOption: false,
        default: false,
        description: "Force the CLI to generate ASKIR without validation.",
    })
        .option("profile", {
        type: "string",
        requiresArg: false,
        description: "ASK CLI profile to use for the Skill.",
    }))
        .command("decompile", "decompile ASKIR files to ACDL files and move the ASKIR files to the build directory", (yargs) => yargs
        .option("profile", {
        type: "string",
        requiresArg: false,
        description: "ASK CLI profile to use for the Skill.",
    })
        .option("out-dir", {
        type: "string",
        requiresArg: false,
        description: "ASK CLI profile to use when deploying the Skill.",
    }))
        .command("deploy", "package and deploy the skill", (yargs) => yargs
        .option("skill-id", {
        type: "string",
        demandOption: true,
        requiresArg: true,
        description: "Skill ID to deploy",
    })
        .option("profile", {
        type: "string",
        requiresArg: true,
        description: "ASK CLI profile to use when deploying the Skill.",
        default: "default",
    })
        .option("skill-package", {
        type: "string",
        requiresArg: true,
        description: "Optional path of a pre-compiled skill-package directory. If none is provided, a skill-package will be compiled from source.",
    }))
        .command("bootstrap-lwa-secrets-manager", "store LWA refresh token credentials in a secure AWS Secret managed by AWS Secrets Manager", (yargs) => yargs
        .option("secret-id", {
        type: "string",
        requiresArg: true,
        demandOption: true,
        description: "ARN of the AWS Secrets Manager credentials to upload the ASK refresh token to",
    })
        .option("profile", {
        type: "string",
        requiresArg: true,
        description: "ASK CLI profile to use when deploying the Skill.",
        default: "default",
    })
        .option("aws-profile", {
        type: "string",
        requiresArg: true,
        description: "name of profile configured in ~/.aws/config and ~/.aws/credentials",
        default: "default",
    })
        .option("aws-region", {
        type: "string",
        requiresArg: true,
        description: "AWS region the Secret Resides in",
    }))
        .command("bootstrap", "Creates a CloudFormation stack with a Secure AWS Secret Manager and uploads your LWA credentials credential to the Secret.", (yargs) => yargs
        .option("secret-name", {
        type: "string",
        requiresArg: true,
        demandOption: false,
        description: "Name of the AWS Secret to upload the ASK credentials to.",
    })
        .option("profile", {
        type: "string",
        requiresArg: true,
        description: "ASK CLI profile to use when deploying the Skill.",
        default: "default",
    })
        .option("aws-profile", {
        type: "string",
        requiresArg: true,
        description: "Name of the AWS profile configured in ~/.aws/config and ~/.aws/credentials.",
        default: "default",
    })
        .option("regions", {
        type: "string",
        requiresArg: true,
        description: "AWS Regions to create the CFN stacks and AWS secrets into.",
    })
        .option("client_id", {
        type: "string",
        requiresArg: true,
        description: "The login-with-amazon client id to store in the AWS secret.",
    })
        .option("client_secret", {
        type: "string",
        requiresArg: true,
        description: "The login-with-amazon client secret to store in the AWS secret.",
    })
        .option("skip-stack", {
        type: "boolean",
        default: false,
        description: "Skips creating a CloudFormation Stack and creates the AWS Secret. This may lead to dangling resources.",
    }))
        .option("verbose", {
        alias: "v",
        type: "boolean",
        description: "Run with verbose logging",
        default: false,
    })
        .option("skip-validation", {
        type: "boolean",
        demandOption: false,
        default: false,
        description: "Force the CLI to generate ASKIR without validation.",
    })
        .option("profile", {
        type: "string",
        requiresArg: false,
        description: "ASK CLI profile to use for the Skill.",
    })
        .parserConfiguration({
        "camel-case-expansion": false,
    })
        .strict();
    return argv;
}
/**
 * Runs the command
 * @param command command to run
 * @param argv command line arguments
 * @param localNpmVersion current npm package version
 * @param askCliConfig config file information
 * A promossed that resolves when the command is done
 */
async function runCommand(command, argv, localNpmVersion, askCliConfig) {
    await NPMPackageVersionCheck_1.NPMPackageVersionCheck.Check(localNpmVersion);
    if (command === "bootstrap-lwa-secrets-manager") {
        await bootstrapLwa();
    }
    else if (command === "bootstrap") {
        await bootstrap();
    }
    else if (command === "decompile") {
        const profile = ProfileNameGetter_1.ProfileNameGetter.getProfileName(argv["profile"]);
        await Decompile_1.Decompile.decompile(process.cwd(), argv["out-dir"], profile);
    }
    else {
        // command === "compile" || command === "package" || command === "deploy" || !command
        const profile = ProfileNameGetter_1.ProfileNameGetter.getProfileName(argv["profile"]);
        await CompileZipAndDeploy_1.CompileZipAndDeploy.compileZipAndDeploy(argv["skip-validation"], profile, argv["skill-id"], command, askCliConfig);
    }
    /**
     * Uploads a login-with-amazon (LWA) profile to AWS secrets manager.
     *
     * TODO: get secret ID from the CFN stack output - https://github.com/aws/aws-cdk/issues/1773
     */
    async function bootstrapLwa() {
        var _a;
        // @see https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/setting-region.html#setting-region-config-file
        process.env.AWS_SDK_LOAD_CONFIG = "true";
        const smapi = await CompileZipAndDeploy_1.CompileZipAndDeploy.initSmapi(argv["profile"] || "default", askCliConfig);
        const credentials = await (0, credential_provider_node_1.defaultProvider)({
            profile: (_a = argv["aws-profile"]) !== null && _a !== void 0 ? _a : "default",
        });
        const secretManager = new client_secrets_manager_1.SecretsManager({ credentials, region: argv["aws-region"] });
        // store the profile as JSON in secrets manager
        await secretManager.putSecretValue({
            SecretId: argv["secret-id"],
            SecretString: JSON.stringify(smapi.profile),
        });
    }
    /**
     * Uploads a login-with-amazon (LWA) profile to AWS secrets manager.
     *
     * TODO: get secret ID from the CFN stack output - https://github.com/aws/aws-cdk/issues/1773
     */
    async function bootstrap() {
        var _a, _b, _c, _d;
        // @see https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/setting-region.html#setting-region-config-file
        process.env.AWS_SDK_LOAD_CONFIG = "true";
        const regions = (_b = (_a = argv.regions) === null || _a === void 0 ? void 0 : _a.split(",")) !== null && _b !== void 0 ? _b : [];
        const skipStack = argv["skip-stack"];
        // If the user doesn't provide regions, then SecretsManager will
        // use the default AWS CLI region instead of undefined
        if (regions.length === 0) {
            regions.push(undefined);
        }
        const smapi = await CompileZipAndDeploy_1.CompileZipAndDeploy.initSmapi(argv["profile"] || "default", askCliConfig);
        const clientId = argv.client_id;
        const clientSecret = argv.client_secret;
        if (clientId) {
            smapi.profile.client_id = clientId;
        }
        if (clientSecret) {
            smapi.profile.client_secret = clientSecret;
        }
        const credentials = await (0, credential_provider_node_1.defaultProvider)({
            profile: (_c = argv["aws-profile"]) !== null && _c !== void 0 ? _c : "default",
        })();
        const secretName = (_d = argv["secret-name"]) !== null && _d !== void 0 ? _d : `ask-config-${smapi.profile.vendor_id}`;
        const CfnTemplate = {
            AWSTemplateFormatVersion: "2010-09-09",
            Resources: {
                AskConfigSecret: {
                    Type: "AWS::SecretsManager::Secret",
                    Properties: {
                        Name: secretName,
                        Description: "Secret creation for Alexa Skills Kit.",
                    },
                },
            },
        };
        const stackParams = {
            StackName: secretName,
            TemplateBody: JSON.stringify(CfnTemplate),
        };
        // Create or update the secret in each region
        for (const region of regions) {
            const cloudformation = new client_cloudformation_1.CloudFormation({ credentials, region });
            const secretManager = new client_secrets_manager_1.SecretsManager({ credentials, region });
            // Grab the region from cloudformation if user did not input any regions
            const awsRegion = cloudformation.config.region;
            // Create the CFN stack to store the AWS Secret. If the stack already exists,
            // the CFN API returns an AlreadyExistsException
            try {
                if (skipStack) {
                    await secretManager.createSecret({ Name: secretName });
                    console.log(`Created secret ${secretName} in ${awsRegion}.`);
                }
                else {
                    const stackId = (await cloudformation.createStack(stackParams)).StackId;
                    console.log(`Starting creation of ${secretName} Stack in ${awsRegion}.`);
                    await pollStackCreation(cloudformation, stackId, awsRegion);
                }
            }
            catch (err) {
                const resource = skipStack ? "Secret" : "Stack";
                if (err.code === "AlreadyExistsException") {
                    console.log(`${secretName} ${resource} already exists in ${awsRegion}. Skipping creation.`);
                }
                else {
                    console.log(`Error creating ${resource}: ${secretName} in ${awsRegion}.`);
                    throw err;
                }
            }
            // Store the ASK profile as JSON in secrets manager
            try {
                await secretManager.putSecretValue({
                    SecretId: secretName,
                    SecretString: JSON.stringify(smapi.profile),
                });
                console.log(`Successfully uploaded LWA credentials to AWS secret ${secretName} in ${awsRegion}.`);
            }
            catch (err) {
                console.log(`Failed uploading LWA credentials to AWS secret ${secretName} in ${awsRegion}.`);
                throw err;
            }
        }
        // Polls the stack creation until the status is complete
        // Throws an error if there is an unexpected status
        async function pollStackCreation(cloudformation, stackId, region) {
            try {
                const stacks = (await cloudformation.describeStacks({ StackName: stackId })).Stacks;
                if (stacks === undefined) {
                    throw new Error("Error creating the CloudFormation stack. Stack doesn't exist.");
                }
                const stack = stacks[0];
                const status = stack.StackStatus;
                if (status === "CREATE_COMPLETE") {
                    console.log(`Created ${secretName} Stack in ${region}`);
                }
                else if (status === "REVIEW_IN_PROGRESS" || status === "CREATE_IN_PROGRESS") {
                    console.log(`Stack(${region}) status: ${status}`);
                    await new Promise((resolve) => {
                        setTimeout(resolve, 2000);
                    });
                    await pollStackCreation(cloudformation, stackId, region);
                }
                else {
                    // Occurs when the stack fails to create with a CREATE_FAILED status
                    throw new Error(`Error creating ${secretName} Stack in ${region}. Encountered ${status} status. Status reason: ${stack.StackStatusReason}.`);
                }
            }
            catch (err) {
                console.log(err);
                console.log(`You may need to manually delete the Stack(${region}) from CloudFormation.`);
                throw err;
            }
        }
    }
}
exports.runCommand = runCommand;
/**
 * Reads the closest package.json looking for a version
 * @param currentDir directory to start looking for package.json from
 * @returns promise with the version resolved when package.json is read
 */
async function getPkgManifestVersion(currentDir) {
    const potentialPkgPath = path_1.default.resolve(currentDir, "package.json");
    if (await (0, util_1.isFile)(potentialPkgPath)) {
        return (0, util_1.readAndParseMandatoryJSONFileSync)(potentialPkgPath).version;
    }
    const nextDir = path_1.default.resolve(currentDir, "..");
    if (nextDir === currentDir) {
        // if we get to the root nextDir will be currentDir so return a default
        return "0.0.0";
    }
    return getPkgManifestVersion(nextDir);
}
/**
 * acc entrypoint that runs the command issuing metrics
 */
async function main() {
    let localNpmVersion;
    try {
        localNpmVersion = await getPkgManifestVersion(__dirname);
    }
    catch (err) {
        console.error(err);
        process.exit(1);
    }
    const askCliConfig = new ask_cli_config_1.AskCliConfig();
    const argv = getArguments(localNpmVersion);
    const command = typeof argv._[0] === "string" ? argv._[0] : "";
    const metrics = new metric_client_1.MetricClient(localNpmVersion, askCliConfig);
    metrics.startAction(command, "");
    try {
        await runCommand(command, argv, localNpmVersion, askCliConfig);
        console.log("SUCCESS");
        await metrics.sendData();
    }
    catch (err) {
        if (Array.isArray(err)) {
            (0, error_1.logProjectErrors)(err);
            // Arrays of ParseErrors correspond to acdl errors. Errors under the
            // control of the skill developer are not considered a failure
            await metrics.sendData();
        }
        else {
            console.error(err);
            if (err.uri) {
                // This is a FileError like JSON parsing issue. Errors under the
                // control of the skill developer are not considered a failure
                await metrics.sendData();
            }
            else {
                await metrics.sendData((0, error_1.stringifyError)(err));
            }
        }
        console.log("FAILURE");
        process.exit(1);
    }
}
main();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWNjLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2FjYy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQ0EsdUNBQXFDO0FBRXJDLDBFQUE4RDtBQUM5RCw0RUFBK0Q7QUFDL0QsZ0ZBQWtFO0FBRWxFLGdEQUF3QjtBQUN4QixrREFBMEI7QUFFMUIsaUNBQWlFO0FBQ2pFLCtEQUEwRDtBQUMxRCwrQ0FBMEM7QUFDMUMsbUVBQThEO0FBQzlELHlFQUFvRTtBQUNwRSxxREFBOEM7QUFDOUMsMkRBQXFEO0FBQ3JELG1DQUFnRjtBQUVoRjs7OztHQUlHO0FBQ0gsU0FBUyxZQUFZLENBQUMsZUFBdUI7SUFDM0MsTUFBTSxFQUFDLElBQUksRUFBQyxHQUFHLElBQUEsZUFBSyxFQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ3hDLFVBQVUsQ0FBQyxLQUFLLENBQUM7U0FDakIsT0FBTyxDQUFDLGVBQWUsQ0FBQztTQUN4QixLQUFLLENBQUMsV0FBVyxDQUFDO1NBQ2xCLEtBQUssQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDO1NBQ2xCLElBQUksQ0FBQyxNQUFNLENBQUM7U0FDWixjQUFjLENBQUMsSUFBSSxDQUFDO1FBRXJCLDZFQUE2RTtTQUM1RSxPQUFPLENBQUMsU0FBUyxFQUFFLG9DQUFvQyxFQUFFLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FDbEUsS0FBSztTQUNGLE1BQU0sQ0FBQyxpQkFBaUIsRUFBRTtRQUN6QixJQUFJLEVBQUUsU0FBUztRQUNmLFlBQVksRUFBRSxLQUFLO1FBQ25CLE9BQU8sRUFBRSxLQUFLO1FBQ2QsV0FBVyxFQUFFLHFEQUFxRDtLQUNuRSxDQUFDO1NBQ0QsTUFBTSxDQUFDLFNBQVMsRUFBRTtRQUNqQixJQUFJLEVBQUUsUUFBUTtRQUNkLFdBQVcsRUFBRSxLQUFLO1FBQ2xCLFdBQVcsRUFBRSx1Q0FBdUM7S0FDckQsQ0FBQyxDQUNMO1NBQ0EsT0FBTyxDQUFDLFNBQVMsRUFBRSx3QkFBd0IsRUFBRSxDQUFDLEtBQUssRUFBRSxFQUFFLENBQ3RELEtBQUs7U0FDRixNQUFNLENBQUMsaUJBQWlCLEVBQUU7UUFDekIsSUFBSSxFQUFFLFNBQVM7UUFDZixZQUFZLEVBQUUsS0FBSztRQUNuQixPQUFPLEVBQUUsS0FBSztRQUNkLFdBQVcsRUFBRSxxREFBcUQ7S0FDbkUsQ0FBQztTQUNELE1BQU0sQ0FBQyxTQUFTLEVBQUU7UUFDakIsSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsS0FBSztRQUNsQixXQUFXLEVBQUUsdUNBQXVDO0tBQ3JELENBQUMsQ0FDTDtTQUNBLE9BQU8sQ0FBQyxXQUFXLEVBQUUscUZBQXFGLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUNySCxLQUFLO1NBQ0YsTUFBTSxDQUFDLFNBQVMsRUFBRTtRQUNqQixJQUFJLEVBQUUsUUFBUTtRQUNkLFdBQVcsRUFBRSxLQUFLO1FBQ2xCLFdBQVcsRUFBRSx1Q0FBdUM7S0FDckQsQ0FBQztTQUNELE1BQU0sQ0FBQyxTQUFTLEVBQUU7UUFDakIsSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsS0FBSztRQUNsQixXQUFXLEVBQUUsa0RBQWtEO0tBQ2hFLENBQUMsQ0FDTDtTQUNBLE9BQU8sQ0FBQyxRQUFRLEVBQUUsOEJBQThCLEVBQUUsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUMzRCxLQUFLO1NBQ0YsTUFBTSxDQUFDLFVBQVUsRUFBRTtRQUNsQixJQUFJLEVBQUUsUUFBUTtRQUNkLFlBQVksRUFBRSxJQUFJO1FBQ2xCLFdBQVcsRUFBRSxJQUFJO1FBQ2pCLFdBQVcsRUFBRSxvQkFBb0I7S0FDbEMsQ0FBQztTQUNELE1BQU0sQ0FBQyxTQUFTLEVBQUU7UUFDakIsSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsSUFBSTtRQUNqQixXQUFXLEVBQUUsa0RBQWtEO1FBQy9ELE9BQU8sRUFBRSxTQUFTO0tBQ25CLENBQUM7U0FDRCxNQUFNLENBQUMsZUFBZSxFQUFFO1FBQ3ZCLElBQUksRUFBRSxRQUFRO1FBQ2QsV0FBVyxFQUFFLElBQUk7UUFDakIsV0FBVyxFQUNULDZIQUE2SDtLQUNoSSxDQUFDLENBQ0w7U0FDQSxPQUFPLENBQ04sK0JBQStCLEVBQy9CLDJGQUEyRixFQUMzRixDQUFDLEtBQUssRUFBRSxFQUFFLENBQ1IsS0FBSztTQUNGLE1BQU0sQ0FBQyxXQUFXLEVBQUU7UUFDbkIsSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsSUFBSTtRQUNqQixZQUFZLEVBQUUsSUFBSTtRQUNsQixXQUFXLEVBQUUsK0VBQStFO0tBQzdGLENBQUM7U0FDRCxNQUFNLENBQUMsU0FBUyxFQUFFO1FBQ2pCLElBQUksRUFBRSxRQUFRO1FBQ2QsV0FBVyxFQUFFLElBQUk7UUFDakIsV0FBVyxFQUFFLGtEQUFrRDtRQUMvRCxPQUFPLEVBQUUsU0FBUztLQUNuQixDQUFDO1NBQ0QsTUFBTSxDQUFDLGFBQWEsRUFBRTtRQUNyQixJQUFJLEVBQUUsUUFBUTtRQUNkLFdBQVcsRUFBRSxJQUFJO1FBQ2pCLFdBQVcsRUFBRSxvRUFBb0U7UUFDakYsT0FBTyxFQUFFLFNBQVM7S0FDbkIsQ0FBQztTQUNELE1BQU0sQ0FBQyxZQUFZLEVBQUU7UUFDcEIsSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsSUFBSTtRQUNqQixXQUFXLEVBQUUsa0NBQWtDO0tBQ2hELENBQUMsQ0FDUDtTQUNBLE9BQU8sQ0FDTixXQUFXLEVBQ1gsNEhBQTRILEVBQzVILENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FDUixLQUFLO1NBQ0YsTUFBTSxDQUFDLGFBQWEsRUFBRTtRQUNyQixJQUFJLEVBQUUsUUFBUTtRQUNkLFdBQVcsRUFBRSxJQUFJO1FBQ2pCLFlBQVksRUFBRSxLQUFLO1FBQ25CLFdBQVcsRUFBRSwwREFBMEQ7S0FDeEUsQ0FBQztTQUNELE1BQU0sQ0FBQyxTQUFTLEVBQUU7UUFDakIsSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsSUFBSTtRQUNqQixXQUFXLEVBQUUsa0RBQWtEO1FBQy9ELE9BQU8sRUFBRSxTQUFTO0tBQ25CLENBQUM7U0FDRCxNQUFNLENBQUMsYUFBYSxFQUFFO1FBQ3JCLElBQUksRUFBRSxRQUFRO1FBQ2QsV0FBVyxFQUFFLElBQUk7UUFDakIsV0FBVyxFQUFFLDZFQUE2RTtRQUMxRixPQUFPLEVBQUUsU0FBUztLQUNuQixDQUFDO1NBQ0QsTUFBTSxDQUFDLFNBQVMsRUFBRTtRQUNqQixJQUFJLEVBQUUsUUFBUTtRQUNkLFdBQVcsRUFBRSxJQUFJO1FBQ2pCLFdBQVcsRUFBRSw0REFBNEQ7S0FDMUUsQ0FBQztTQUNELE1BQU0sQ0FBQyxXQUFXLEVBQUU7UUFDbkIsSUFBSSxFQUFFLFFBQVE7UUFDZCxXQUFXLEVBQUUsSUFBSTtRQUNqQixXQUFXLEVBQUUsNkRBQTZEO0tBQzNFLENBQUM7U0FDRCxNQUFNLENBQUMsZUFBZSxFQUFFO1FBQ3ZCLElBQUksRUFBRSxRQUFRO1FBQ2QsV0FBVyxFQUFFLElBQUk7UUFDakIsV0FBVyxFQUFFLGlFQUFpRTtLQUMvRSxDQUFDO1NBQ0QsTUFBTSxDQUFDLFlBQVksRUFBRTtRQUNwQixJQUFJLEVBQUUsU0FBUztRQUNmLE9BQU8sRUFBRSxLQUFLO1FBQ2QsV0FBVyxFQUFFLHdHQUF3RztLQUN0SCxDQUFDLENBQ1A7U0FDQSxNQUFNLENBQUMsU0FBUyxFQUFFO1FBQ2pCLEtBQUssRUFBRSxHQUFHO1FBQ1YsSUFBSSxFQUFFLFNBQVM7UUFDZixXQUFXLEVBQUUsMEJBQTBCO1FBQ3ZDLE9BQU8sRUFBRSxLQUFLO0tBQ2YsQ0FBQztTQUNELE1BQU0sQ0FBQyxpQkFBaUIsRUFBRTtRQUN6QixJQUFJLEVBQUUsU0FBUztRQUNmLFlBQVksRUFBRSxLQUFLO1FBQ25CLE9BQU8sRUFBRSxLQUFLO1FBQ2QsV0FBVyxFQUFFLHFEQUFxRDtLQUNuRSxDQUFDO1NBQ0QsTUFBTSxDQUFDLFNBQVMsRUFBRTtRQUNqQixJQUFJLEVBQUUsUUFBUTtRQUNkLFdBQVcsRUFBRSxLQUFLO1FBQ2xCLFdBQVcsRUFBRSx1Q0FBdUM7S0FDckQsQ0FBQztTQUNELG1CQUFtQixDQUFDO1FBQ25CLHNCQUFzQixFQUFFLEtBQUs7S0FDOUIsQ0FBQztTQUNELE1BQU0sRUFBRSxDQUFDO0lBQ1osT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBRUQ7Ozs7Ozs7R0FPRztBQUNJLEtBQUssVUFBVSxVQUFVLENBQUMsT0FBZSxFQUFFLElBQVMsRUFBRSxlQUF1QixFQUFFLFlBQTBCO0lBQzlHLE1BQU0sK0NBQXNCLENBQUMsS0FBSyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBRXBELElBQUksT0FBTyxLQUFLLCtCQUErQixFQUFFO1FBQy9DLE1BQU0sWUFBWSxFQUFFLENBQUM7S0FDdEI7U0FBTSxJQUFJLE9BQU8sS0FBSyxXQUFXLEVBQUU7UUFDbEMsTUFBTSxTQUFTLEVBQUUsQ0FBQztLQUNuQjtTQUFNLElBQUksT0FBTyxLQUFLLFdBQVcsRUFBRTtRQUNsQyxNQUFNLE9BQU8sR0FBRyxxQ0FBaUIsQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7UUFDbEUsTUFBTSxxQkFBUyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0tBQ3BFO1NBQU07UUFDTCxxRkFBcUY7UUFDckYsTUFBTSxPQUFPLEdBQUcscUNBQWlCLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1FBQ2xFLE1BQU0seUNBQW1CLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxVQUFVLENBQUMsRUFBRSxPQUFPLEVBQUUsWUFBWSxDQUFDLENBQUM7S0FDMUg7SUFFRDs7OztPQUlHO0lBQ0gsS0FBSyxVQUFVLFlBQVk7O1FBQ3pCLHdIQUF3SDtRQUN4SCxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixHQUFHLE1BQU0sQ0FBQztRQUN6QyxNQUFNLEtBQUssR0FBRyxNQUFNLHlDQUFtQixDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksU0FBUyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQzlGLE1BQU0sV0FBVyxHQUFHLE1BQU0sSUFBQSwwQ0FBZSxFQUFDO1lBQ3hDLE9BQU8sRUFBRSxNQUFBLElBQUksQ0FBQyxhQUFhLENBQUMsbUNBQUksU0FBUztTQUMxQyxDQUFDLENBQUM7UUFDSCxNQUFNLGFBQWEsR0FBRyxJQUFJLHVDQUFjLENBQUMsRUFBQyxXQUFXLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsRUFBQyxDQUFDLENBQUM7UUFDcEYsK0NBQStDO1FBQy9DLE1BQU0sYUFBYSxDQUFDLGNBQWMsQ0FBQztZQUNqQyxRQUFRLEVBQUUsSUFBSSxDQUFDLFdBQVcsQ0FBQztZQUMzQixZQUFZLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDO1NBQzVDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsS0FBSyxVQUFVLFNBQVM7O1FBQ3RCLHdIQUF3SDtRQUN4SCxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixHQUFHLE1BQU0sQ0FBQztRQUV6QyxNQUFNLE9BQU8sR0FBMkIsTUFBQSxNQUFBLElBQUksQ0FBQyxPQUFPLDBDQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsbUNBQUksRUFBRSxDQUFDO1FBQ3ZFLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNyQyxnRUFBZ0U7UUFDaEUsc0RBQXNEO1FBQ3RELElBQUksT0FBTyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7WUFDeEIsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztTQUN6QjtRQUVELE1BQU0sS0FBSyxHQUFHLE1BQU0seUNBQW1CLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDOUYsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQztRQUNoQyxNQUFNLFlBQVksR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDO1FBRXhDLElBQUksUUFBUSxFQUFFO1lBQ1osS0FBSyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDO1NBQ3BDO1FBQ0QsSUFBSSxZQUFZLEVBQUU7WUFDaEIsS0FBSyxDQUFDLE9BQU8sQ0FBQyxhQUFhLEdBQUcsWUFBWSxDQUFDO1NBQzVDO1FBQ0QsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFBLDBDQUFlLEVBQUM7WUFDeEMsT0FBTyxFQUFFLE1BQUEsSUFBSSxDQUFDLGFBQWEsQ0FBQyxtQ0FBSSxTQUFTO1NBQzFDLENBQUMsRUFBRSxDQUFDO1FBRUwsTUFBTSxVQUFVLEdBQUcsTUFBQSxJQUFJLENBQUMsYUFBYSxDQUFDLG1DQUFJLGNBQWMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxTQUFTLEVBQUUsQ0FBQztRQUVsRixNQUFNLFdBQVcsR0FBRztZQUNsQix3QkFBd0IsRUFBRSxZQUFZO1lBQ3RDLFNBQVMsRUFBRTtnQkFDVCxlQUFlLEVBQUU7b0JBQ2YsSUFBSSxFQUFFLDZCQUE2QjtvQkFDbkMsVUFBVSxFQUFFO3dCQUNWLElBQUksRUFBRSxVQUFVO3dCQUNoQixXQUFXLEVBQUUsdUNBQXVDO3FCQUNyRDtpQkFDRjthQUNGO1NBQ0YsQ0FBQztRQUVGLE1BQU0sV0FBVyxHQUFHO1lBQ2xCLFNBQVMsRUFBRSxVQUFVO1lBQ3JCLFlBQVksRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQztTQUMxQyxDQUFDO1FBRUYsNkNBQTZDO1FBQzdDLEtBQUssTUFBTSxNQUFNLElBQUksT0FBTyxFQUFFO1lBQzVCLE1BQU0sY0FBYyxHQUFHLElBQUksc0NBQWMsQ0FBQyxFQUFDLFdBQVcsRUFBRSxNQUFNLEVBQUMsQ0FBQyxDQUFDO1lBQ2pFLE1BQU0sYUFBYSxHQUFHLElBQUksdUNBQWMsQ0FBQyxFQUFDLFdBQVcsRUFBRSxNQUFNLEVBQUMsQ0FBQyxDQUFDO1lBQ2hFLHdFQUF3RTtZQUN4RSxNQUFNLFNBQVMsR0FBRyxjQUFjLENBQUMsTUFBTSxDQUFDLE1BQWdCLENBQUM7WUFFekQsNkVBQTZFO1lBQzdFLGdEQUFnRDtZQUNoRCxJQUFJO2dCQUNGLElBQUksU0FBUyxFQUFFO29CQUNiLE1BQU0sYUFBYSxDQUFDLFlBQVksQ0FBQyxFQUFDLElBQUksRUFBRSxVQUFVLEVBQUMsQ0FBQyxDQUFDO29CQUNyRCxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixVQUFVLE9BQU8sU0FBUyxHQUFHLENBQUMsQ0FBQztpQkFDOUQ7cUJBQU07b0JBQ0wsTUFBTSxPQUFPLEdBQUcsQ0FBQyxNQUFNLGNBQWMsQ0FBQyxXQUFXLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUM7b0JBQ3hFLE9BQU8sQ0FBQyxHQUFHLENBQUMsd0JBQXdCLFVBQVUsYUFBYSxTQUFTLEdBQUcsQ0FBQyxDQUFDO29CQUN6RSxNQUFNLGlCQUFpQixDQUFDLGNBQWMsRUFBRSxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUM7aUJBQzdEO2FBQ0Y7WUFBQyxPQUFPLEdBQVEsRUFBRTtnQkFDakIsTUFBTSxRQUFRLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQztnQkFDaEQsSUFBSSxHQUFHLENBQUMsSUFBSSxLQUFLLHdCQUF3QixFQUFFO29CQUN6QyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsVUFBVSxJQUFJLFFBQVEsc0JBQXNCLFNBQVMsc0JBQXNCLENBQUMsQ0FBQztpQkFDN0Y7cUJBQU07b0JBQ0wsT0FBTyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsUUFBUSxLQUFLLFVBQVUsT0FBTyxTQUFTLEdBQUcsQ0FBQyxDQUFDO29CQUMxRSxNQUFNLEdBQUcsQ0FBQztpQkFDWDthQUNGO1lBRUQsbURBQW1EO1lBQ25ELElBQUk7Z0JBQ0YsTUFBTSxhQUFhLENBQUMsY0FBYyxDQUFDO29CQUNqQyxRQUFRLEVBQUUsVUFBVTtvQkFDcEIsWUFBWSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQztpQkFDNUMsQ0FBQyxDQUFDO2dCQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsdURBQXVELFVBQVUsT0FBTyxTQUFTLEdBQUcsQ0FBQyxDQUFDO2FBQ25HO1lBQUMsT0FBTyxHQUFHLEVBQUU7Z0JBQ1osT0FBTyxDQUFDLEdBQUcsQ0FBQyxrREFBa0QsVUFBVSxPQUFPLFNBQVMsR0FBRyxDQUFDLENBQUM7Z0JBQzdGLE1BQU0sR0FBRyxDQUFDO2FBQ1g7U0FDRjtRQUVELHdEQUF3RDtRQUN4RCxtREFBbUQ7UUFDbkQsS0FBSyxVQUFVLGlCQUFpQixDQUM5QixjQUE4QixFQUM5QixPQUEyQixFQUMzQixNQUEwQjtZQUUxQixJQUFJO2dCQUNGLE1BQU0sTUFBTSxHQUFHLENBQUMsTUFBTSxjQUFjLENBQUMsY0FBYyxDQUFDLEVBQUMsU0FBUyxFQUFFLE9BQU8sRUFBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUM7Z0JBQ2xGLElBQUksTUFBTSxLQUFLLFNBQVMsRUFBRTtvQkFDeEIsTUFBTSxJQUFJLEtBQUssQ0FBQywrREFBK0QsQ0FBQyxDQUFDO2lCQUNsRjtnQkFFRCxNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3hCLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7Z0JBRWpDLElBQUksTUFBTSxLQUFLLGlCQUFpQixFQUFFO29CQUNoQyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsVUFBVSxhQUFhLE1BQU0sRUFBRSxDQUFDLENBQUM7aUJBQ3pEO3FCQUFNLElBQUksTUFBTSxLQUFLLG9CQUFvQixJQUFJLE1BQU0sS0FBSyxvQkFBb0IsRUFBRTtvQkFDN0UsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLE1BQU0sYUFBYSxNQUFNLEVBQUUsQ0FBQyxDQUFDO29CQUNsRCxNQUFNLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7d0JBQzVCLFVBQVUsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7b0JBQzVCLENBQUMsQ0FBQyxDQUFDO29CQUNILE1BQU0saUJBQWlCLENBQUMsY0FBYyxFQUFFLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQztpQkFDMUQ7cUJBQU07b0JBQ0wsb0VBQW9FO29CQUNwRSxNQUFNLElBQUksS0FBSyxDQUNiLGtCQUFrQixVQUFVLGFBQWEsTUFBTSxpQkFBaUIsTUFBTSwyQkFBMkIsS0FBSyxDQUFDLGlCQUFpQixHQUFHLENBQzVILENBQUM7aUJBQ0g7YUFDRjtZQUFDLE9BQU8sR0FBRyxFQUFFO2dCQUNaLE9BQU8sQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2pCLE9BQU8sQ0FBQyxHQUFHLENBQUMsNkNBQTZDLE1BQU0sd0JBQXdCLENBQUMsQ0FBQztnQkFDekYsTUFBTSxHQUFHLENBQUM7YUFDWDtRQUNILENBQUM7SUFDSCxDQUFDO0FBQ0gsQ0FBQztBQXJLRCxnQ0FxS0M7QUFFRDs7OztHQUlHO0FBQ0gsS0FBSyxVQUFVLHFCQUFxQixDQUFDLFVBQWtCO0lBQ3JELE1BQU0sZ0JBQWdCLEdBQUcsY0FBSSxDQUFDLE9BQU8sQ0FBQyxVQUFVLEVBQUUsY0FBYyxDQUFDLENBQUM7SUFDbEUsSUFBSSxNQUFNLElBQUEsYUFBTSxFQUFDLGdCQUFnQixDQUFDLEVBQUU7UUFDbEMsT0FBTyxJQUFBLHdDQUFpQyxFQUFDLGdCQUFnQixDQUFDLENBQUMsT0FBaUIsQ0FBQztLQUM5RTtJQUNELE1BQU0sT0FBTyxHQUFHLGNBQUksQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQy9DLElBQUksT0FBTyxLQUFLLFVBQVUsRUFBRTtRQUMxQix1RUFBdUU7UUFDdkUsT0FBTyxPQUFPLENBQUM7S0FDaEI7SUFDRCxPQUFPLHFCQUFxQixDQUFDLE9BQU8sQ0FBQyxDQUFDO0FBQ3hDLENBQUM7QUFFRDs7R0FFRztBQUNILEtBQUssVUFBVSxJQUFJO0lBQ2pCLElBQUksZUFBZSxDQUFDO0lBQ3BCLElBQUk7UUFDRixlQUFlLEdBQUcsTUFBTSxxQkFBcUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztLQUMxRDtJQUFDLE9BQU8sR0FBRyxFQUFFO1FBQ1osT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNuQixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2pCO0lBRUQsTUFBTSxZQUFZLEdBQUcsSUFBSSw2QkFBWSxFQUFFLENBQUM7SUFDeEMsTUFBTSxJQUFJLEdBQUcsWUFBWSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQzNDLE1BQU0sT0FBTyxHQUFHLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUMvRCxNQUFNLE9BQU8sR0FBRyxJQUFJLDRCQUFZLENBQUMsZUFBZSxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQ2hFLE9BQU8sQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBRWpDLElBQUk7UUFDRixNQUFNLFVBQVUsQ0FBQyxPQUFPLEVBQUUsSUFBSSxFQUFFLGVBQWUsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUMvRCxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZCLE1BQU0sT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO0tBQzFCO0lBQUMsT0FBTyxHQUFRLEVBQUU7UUFDakIsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQ3RCLElBQUEsd0JBQWdCLEVBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEIsb0VBQW9FO1lBQ3BFLDhEQUE4RDtZQUM5RCxNQUFNLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQztTQUMxQjthQUFNO1lBQ0wsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNuQixJQUFJLEdBQUcsQ0FBQyxHQUFHLEVBQUU7Z0JBQ1gsZ0VBQWdFO2dCQUNoRSw4REFBOEQ7Z0JBQzlELE1BQU0sT0FBTyxDQUFDLFFBQVEsRUFBRSxDQUFDO2FBQzFCO2lCQUFNO2dCQUNMLE1BQU0sT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFBLHNCQUFjLEVBQUMsR0FBWSxDQUFDLENBQUMsQ0FBQzthQUN0RDtTQUNGO1FBRUQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN2QixPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQ2pCO0FBQ0gsQ0FBQztBQUVELElBQUksRUFBRSxDQUFDIn0=