"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.PropertyReference = exports.isPropRef = void 0;
const guard_1 = require("./guard");
const tree_1 = require("./tree");
/**
 * Asserts if the Expression is a `PropertyReference`.
 */
exports.isPropRef = (0, guard_1.guard)("PropertyReference");
/**
 * Represents the access of a Property.
 */
class PropertyReference extends tree_1.Tree {
    constructor(
    /**
     * Name of the property being accessed.
     */
    name, 
    /**
     * Expression containing the property being accessed.
     *
     * Names, Calls and other PropertyAccess nodes are supported.
     */
    expression, annotations, loc) {
        super("PropertyReference", loc);
        Object.defineProperty(this, "name", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: name
        });
        Object.defineProperty(this, "expression", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: expression
        });
        Object.defineProperty(this, "annotations", {
            enumerable: true,
            configurable: true,
            writable: true,
            value: annotations
        });
        this.setAsParentOn(name);
        this.setAsParentOn(expression);
        this.setAsParentOn(annotations);
    }
    clone() {
        var _a, _b, _c;
        return new PropertyReference((_a = this.name) === null || _a === void 0 ? void 0 : _a.clone(), (_b = this.expression) === null || _b === void 0 ? void 0 : _b.clone(), (_c = this.annotations) === null || _c === void 0 ? void 0 : _c.map((a) => a.clone()), this.loc);
    }
    /**
     * Print the full prop chain with dot as the separator.
     *
     * @returns the dot-joined string from the called node to its root
     */
    printPropertyChainThroughRoot(sep) {
        var _a, _b, _c;
        const chainingProps = [(_a = this.name) === null || _a === void 0 ? void 0 : _a.name];
        let temp = this.expression;
        while ((temp === null || temp === void 0 ? void 0 : temp.kind) === "PropertyReference" && ((_b = temp.name) === null || _b === void 0 ? void 0 : _b.name)) {
            chainingProps.push(temp.name.name);
            temp = temp.expression;
        }
        if (temp && ((_c = temp.name) === null || _c === void 0 ? void 0 : _c.name)) {
            chainingProps.push(temp.name.name);
        }
        return chainingProps.reverse().join(sep || ".");
    }
}
exports.PropertyReference = PropertyReference;
(function (PropertyReference) {
    /**
     * Tries to resolves a PropertyReference to a QualifiedName.
     *
     * When we parse qualified names, e.g. `com.amazon.MyIntent`, it is ambiguous
     * as to whether this is
     * 1. `PropertyReference(MyIntent, PropertyReference(amazon, NameReference(com)))`
     * 2. `NameReference(com.amazon.MyIntent)`
     *
     * This function flattens a PropertyReference tree to a qualified name so that it can be checked.
     *
     * @param expr
     */
    function tryResolveQualifiedName(expr) {
        var _a, _b;
        if ((expr === null || expr === void 0 ? void 0 : expr.kind) === "Call") {
            return undefined;
        }
        if ((expr === null || expr === void 0 ? void 0 : expr.kind) === "NameReference") {
            return (_a = expr.name) === null || _a === void 0 ? void 0 : _a.name;
        }
        if ((expr === null || expr === void 0 ? void 0 : expr.kind) === "PropertyReference") {
            const prevName = tryResolveQualifiedName(expr.expression);
            if (prevName) {
                return `${prevName}.${(_b = expr.name) === null || _b === void 0 ? void 0 : _b.name}`;
            }
        }
        return undefined;
    }
    PropertyReference.tryResolveQualifiedName = tryResolveQualifiedName;
    /**
     * Tries to resolves a PropertyReference tree to a SourceLocation spanning the entire tree as
     * if it were a qualified name.
     *
     * When we parse qualified names, e.g. `com.amazon.MyIntent`, it is ambiguous
     * as to whether this is
     * 1. `PropertyReference(MyIntent, PropertyReference(amazon, NameReference(com)))`
     * 2. `NameReference(com.amazon.MyIntent)`
     *
     * @param expr
     */
    function tryResolveQualifiedNameLocation(expr) {
        var _a;
        if (expr === undefined) {
            return undefined;
        }
        const end = (_a = expr === null || expr === void 0 ? void 0 : expr.loc) === null || _a === void 0 ? void 0 : _a.end;
        const begin = findBeginning(expr);
        if (end && begin) {
            return {
                begin,
                end,
            };
        }
        return undefined;
        function findBeginning(expr) {
            var _a;
            if ((expr === null || expr === void 0 ? void 0 : expr.kind) === "NameReference") {
                return (_a = expr.loc) === null || _a === void 0 ? void 0 : _a.begin;
            }
            if ((expr === null || expr === void 0 ? void 0 : expr.kind) === "PropertyReference") {
                return findBeginning(expr.expression);
            }
            return undefined;
        }
    }
    PropertyReference.tryResolveQualifiedNameLocation = tryResolveQualifiedNameLocation;
})(PropertyReference = exports.PropertyReference || (exports.PropertyReference = {}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvcGVydHktcmVmZXJlbmNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2FzdC9wcm9wZXJ0eS1yZWZlcmVuY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsbUNBQThCO0FBTTlCLGlDQUE0QjtBQU81Qjs7R0FFRztBQUNVLFFBQUEsU0FBUyxHQUFHLElBQUEsYUFBSyxFQUFDLG1CQUFtQixDQUFDLENBQUM7QUFFcEQ7O0dBRUc7QUFDSCxNQUFhLGlCQUFrQixTQUFRLFdBQWtEO0lBQ3ZGO0lBQ0U7O09BRUc7SUFDTSxJQUFzQjtJQUMvQjs7OztPQUlHO0lBQ00sVUFBbUQsRUFDbkQsV0FBc0MsRUFDL0MsR0FBZ0M7UUFFaEMsS0FBSyxDQUFDLG1CQUFtQixFQUFFLEdBQUcsQ0FBQyxDQUFDOzs7OzttQkFWdkI7Ozs7OzttQkFNQTs7Ozs7O21CQUNBOztRQUlULElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDekIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUMvQixJQUFJLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ2xDLENBQUM7SUFFTSxLQUFLOztRQUNWLE9BQU8sSUFBSSxpQkFBaUIsQ0FDMUIsTUFBQSxJQUFJLENBQUMsSUFBSSwwQ0FBRSxLQUFLLEVBQUUsRUFDbEIsTUFBQSxJQUFJLENBQUMsVUFBVSwwQ0FBRSxLQUFLLEVBQUUsRUFDeEIsTUFBQSxJQUFJLENBQUMsV0FBVywwQ0FBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxFQUN2QyxJQUFJLENBQUMsR0FBRyxDQUNULENBQUM7SUFDSixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLDZCQUE2QixDQUFDLEdBQVk7O1FBQy9DLE1BQU0sYUFBYSxHQUFHLENBQUMsTUFBQSxJQUFJLENBQUMsSUFBSSwwQ0FBRSxJQUFJLENB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